{
  "project": "fielder-nextjs",
  "description": "Next.js + Supabase migration of Fielder harvest prediction platform",
  "architecture_plan": "Hybrid Intelligence Architecture - SNDBX pattern adapted for agricultural quality prediction",
  "features": [
    {
      "id": "F001",
      "name": "Project Setup",
      "passes": true,
      "steps": [
        "Initialize Next.js with TypeScript + Tailwind",
        "Install Supabase client",
        "Configure project structure"
      ],
      "completion_notes": "Created fielder-nextjs with App Router, TypeScript, Tailwind, @supabase/supabase-js"
    },
    {
      "id": "F002",
      "name": "Supabase Schema",
      "passes": true,
      "steps": [
        "Create Supabase project",
        "Define schema: crops, cultivars, rootstocks, regions",
        "Define schema: farms, farm_crops, farm_availability",
        "Create seed scripts from DataLoader"
      ],
      "completion_notes": "Created migrations/001_initial_schema.sql with all tables. Seed scripts for regions (21 regions) and crops (15 crops) ready."
    },
    {
      "id": "F003",
      "name": "TypeScript Services",
      "passes": true,
      "steps": [
        "Port GDD calculator",
        "Port weather service (Open-Meteo)",
        "Port quality predictor (10 crop models)",
        "Port harvest predictor"
      ],
      "completion_notes": "Ported gdd-calculator.ts, weather.ts, harvest-predictor.ts. Quality predictor sugar/acid estimation included."
    },
    {
      "id": "F004",
      "name": "API Routes",
      "passes": true,
      "steps": [
        "POST /api/predict - harvest window",
        "POST /api/quality - quality prediction",
        "GET /api/weather/gdd - GDD data",
        "GET /api/crops - list crops",
        "GET /api/regions - list regions"
      ],
      "completion_notes": "Created /api/predict, /api/crops, /api/regions, /api/weather/gdd."
    },
    {
      "id": "F005",
      "name": "Consumer Discovery UI",
      "passes": true,
      "steps": [
        "Region selector component",
        "Crop filter component",
        "At Peak Now grid",
        "Harvest calendar view",
        "Farm cards"
      ],
      "completion_notes": "Created /discover page with region selector, At Peak Now section, crop cards with status badges."
    },
    {
      "id": "F006",
      "name": "Farm Dashboard UI",
      "passes": true,
      "steps": [
        "Admin code protection",
        "Profile editor",
        "Crop manager",
        "Availability toggle",
        "Pricing editor"
      ],
      "completion_notes": "Created /farm page with admin code protection and dashboard skeleton."
    },
    {
      "id": "F007",
      "name": "Vercel Deployment",
      "passes": true,
      "steps": [
        "Push to GitHub",
        "Connect Vercel",
        "Configure environment variables",
        "Deploy"
      ],
      "completion_notes": "Deployed to Vercel at https://fielder-nextjs.vercel.app"
    },
    {
      "id": "SPIKE-A",
      "name": "Data Audit",
      "passes": true,
      "phase": "0-spikes",
      "steps": [
        "Count rows in Supabase tables (crops, cultivars, etc.)",
        "List all TypeScript constant files and row counts",
        "Document data quality issues",
        "Map: which constants → which DB tables",
        "Create data audit report"
      ],
      "acceptance": "Data audit report created with migration scope estimate",
      "files": ["docs/data-audit-report.md"],
      "completion_notes": "Created comprehensive data audit report. Found 17,459 lines across 20 constant files. DB has 9 tables (only 2 seeded: 15 crops, 21 regions). Critical: constants have 6x more regions (122 vs 21), cultivars/rootstocks tables empty. Identified migration priorities for F009-F012."
    },
    {
      "id": "SPIKE-B",
      "name": "Rule Extraction Baseline",
      "passes": true,
      "phase": "0-spikes",
      "steps": [
        "grep -r 'GDD|Brix|degree.*day' --include='*.ts' to find all calculation locations",
        "Document all GDD/Brix calculation locations",
        "Write regression tests for current prediction behavior",
        "Identify candidate extractions for F013 Rules Engine"
      ],
      "acceptance": "Rule map created, baseline test suite passes",
      "files": ["docs/rule-extraction-map.md", "src/**/*.test.ts"],
      "completion_notes": "Created docs/rule-extraction-map.md documenting 18 rule functions across 7 files. Added 68 regression tests in harvest-predictor.test.ts (29 tests) and reference-data.test.ts (39 tests). Identified 5 CRITICAL + 7 HIGH priority extraction candidates for F013. Documented formulas: GDD, sigmoid sugar accumulation, exponential acid decay, peak Brix (SHARE), age modifier lookup, timing modifier parabolic."
    },
    {
      "id": "SPIKE-C",
      "name": "ML Architecture Decision",
      "passes": true,
      "phase": "0-spikes",
      "steps": [
        "Decide: Supabase Edge Functions vs separate Python service",
        "Decide: Training pipeline (batch vs online)",
        "Decide: Model storage (Supabase vs S3)",
        "Document A/B framework requirements",
        "Create Architecture Decision Record (ADR)"
      ],
      "acceptance": "ADR created with ML hosting decisions",
      "files": ["docs/adr-ml-architecture.md"],
      "completion_notes": "Created ADR-001 with 4 key decisions: (1) Hybrid hosting - TypeScript inference in Next.js/Edge, Python for training; (2) Batch training pipeline with weekly retraining; (3) Supabase tables for small models, Storage for larger artifacts, S3 fallback; (4) Database-driven A/B testing with consistent hash assignment. Defined model_versions and regional_calibrations schema."
    },
    {
      "id": "F008",
      "name": "Test Infrastructure Setup",
      "passes": true,
      "phase": "1-foundation",
      "steps": [
        "Install Jest, ts-jest, @testing-library/react",
        "Configure jest.config.js for Next.js",
        "Add test scripts to package.json",
        "Write initial smoke tests for existing services",
        "Verify all tests pass"
      ],
      "acceptance": "npm test runs successfully with >0 passing tests",
      "files": ["package.json", "jest.config.js", "src/**/*.test.ts"],
      "completion_notes": "Installed Jest 30 + ts-jest + testing-library. Created jest.config.js with ts-jest preset, path aliases, jsdom environment. Added 55 tests for gdd-calculator.ts and gdd.ts prediction functions. All tests pass."
    },
    {
      "id": "F009",
      "name": "Reference Data Service",
      "passes": true,
      "phase": "1-foundation",
      "steps": [
        "Create src/lib/data/reference-data.ts",
        "Implement getCultivar(), getRootstock(), getRegion() methods",
        "Add caching layer (in-memory Map with TTL)",
        "Feature flag: USE_DATABASE_REFERENCE_DATA",
        "Write tests for data service"
      ],
      "acceptance": "Tests pass, predictions work with DB or constants fallback",
      "files": ["src/lib/data/reference-data.ts", "src/__tests__/reference-data-service.test.ts"],
      "completion_notes": "Created reference data service with: (1) USE_DATABASE_REFERENCE_DATA feature flag; (2) In-memory cache with 5-minute TTL; (3) Async methods for cultivar, rootstock, region, GDD targets; (4) Graceful fallback to constants on DB error; (5) Sync versions for non-async contexts. 35 tests passing."
    },
    {
      "id": "F010",
      "name": "Seed Crops Table",
      "passes": true,
      "phase": "1-foundation",
      "steps": [
        "Create seed file supabase/seed/003_crops_full.sql",
        "Add 20+ crops with GDD targets, base temps",
        "Run migration against Supabase",
        "Verify via reference-data.ts queries",
        "Write validation tests"
      ],
      "acceptance": "All crops queryable from DB, tests pass",
      "files": ["supabase/seed/003_crops_full.sql", "src/__tests__/crops-data-validation.test.ts"],
      "completion_notes": "Verified and updated 15 crops in Supabase to match TypeScript constants (peach, sweet_cherry, tart_cherry, apple, pear, strawberry, blueberry, mango, pomegranate, pecan). Created 39 validation tests in crops-data-validation.test.ts covering all crop categories (citrus, stone fruit, pome, berries, tropical, nuts)."
    },
    {
      "id": "F011",
      "name": "Seed Cultivars Table",
      "passes": true,
      "phase": "1-foundation",
      "steps": [
        "Create seed file supabase/seed/004_cultivars.sql",
        "Add 11+ cultivars with brix_base, timing_class",
        "Run migration against Supabase",
        "Update reference-data.ts to query cultivars",
        "Write validation tests"
      ],
      "acceptance": "All cultivars queryable, tests pass",
      "files": ["supabase/seed/004_cultivars.sql", "src/__tests__/cultivars-data-validation.test.ts"],
      "completion_notes": "Seeded 12 cultivars (3 navel oranges, 2 grapefruit, 2 peaches, 2 strawberries, 3 apples) to Supabase via direct SQL. Created 42 validation tests covering all cultivar categories, quality tiers, heritage classification, and data consistency."
    },
    {
      "id": "F012",
      "name": "Seed Rootstocks Table",
      "passes": true,
      "phase": "1-foundation",
      "steps": [
        "Create seed file supabase/seed/005_rootstocks.sql",
        "Add 12 rootstocks with brix_modifier, vigor",
        "Run migration against Supabase",
        "Update reference-data.ts to query rootstocks",
        "Write validation tests"
      ],
      "acceptance": "All rootstocks queryable, tests pass",
      "files": ["supabase/seed/005_rootstocks.sql", "src/__tests__/rootstocks-data-validation.test.ts"],
      "completion_notes": "Seeded 12 rootstocks (9 citrus + 3 stone fruit) to Supabase via direct SQL. Adjusted vigor values to match DB constraint (dwarf/semi-dwarf/standard). Created 40 validation tests covering Brix modifier values, data consistency, lookup functions, and quality ordering."
    },
    {
      "id": "F013",
      "name": "SHARE Rules Engine",
      "passes": true,
      "phase": "2-deterministic",
      "steps": [
        "Create src/lib/intelligence/rules-engine.ts",
        "Implement getRootstockModifier() - deterministic lookup",
        "Implement getAgeModifier() - age curve calculation",
        "Implement getCultivarBaseBrix() - from DB",
        "Write comprehensive tests"
      ],
      "acceptance": "Rules engine replaces inline calculations, tests pass",
      "files": ["src/lib/intelligence/rules-engine.ts", "src/__tests__/rules-engine.test.ts"],
      "completion_notes": "Created comprehensive rules engine with: (1) Age modifier lookup with phase info (juvenile→declining); (2) Timing modifier with parabolic penalty and zone classification; (3) Rootstock modifier via reference-data service; (4) Cultivar base Brix via reference-data service; (5) Sugar/acid curve calculations (logistic sugar, exponential acid decay); (6) Complete Brix components calculation; (7) Validation helpers. 65 tests covering all rules. Total test suite: 344 tests."
    },
    {
      "id": "F014",
      "name": "Claim Inference Engine",
      "passes": true,
      "phase": "2-deterministic",
      "steps": [
        "Create src/lib/intelligence/claim-inference.ts",
        "Implement inferFromPLU() - PLU prefix logic",
        "Implement inferBeefProfile() - CAFO detection chain",
        "Implement checkOrganicBeefWarning() - red flag detection",
        "Write tests for all inference chains"
      ],
      "acceptance": "Claim inference works standalone, tests pass",
      "files": ["src/lib/intelligence/claim-inference.ts", "src/__tests__/claim-inference.test.ts"],
      "completion_notes": "Created comprehensive claim inference engine with: (1) PLU code inference (prefix 9=organic, prefix 8=GMO); (2) GMO risk crop detection; (3) Beef profile inference (7 profiles A-F with CAFO detection, omega ratio expectations); (4) Organic meat warning system (critical/warning/info severity); (5) Omega ratio validation against claimed profiles. 102 tests covering PLU inference, all beef profiles, real-world scenarios (Everglades Ranch, Snake River Farms). Total test suite: 446 tests."
    },
    {
      "id": "F015",
      "name": "Validation Engine",
      "passes": true,
      "phase": "2-deterministic",
      "steps": [
        "Create src/lib/intelligence/validation-engine.ts",
        "Implement enforcePhysicalConstraints() - Brix 0-30, omega 1-30",
        "Implement validateMeasurement() - data quality checks",
        "Implement isAnomalousMeasurement() - outlier detection",
        "Write tests"
      ],
      "acceptance": "All predictions pass through validation, tests pass",
      "files": ["src/lib/intelligence/validation-engine.ts", "src/__tests__/validation-engine.test.ts"],
      "completion_notes": "Created validation engine with: (1) Physical constraints for Brix, omega, GDD, tree age, pH, moisture; (2) Typical ranges for produce categories and omega profiles; (3) enforcePhysicalConstraints() with per-field validators; (4) validateMeasurement() for data quality with consistency checks; (5) assessDataQuality() returning 0-1 score; (6) Z-score anomaly detection; (7) detectBrixAnomaly() and detectOmegaAnomaly() for cultivar/profile-specific outlier detection. 89 tests. Total test suite: 535 tests."
    },
    {
      "id": "F016",
      "name": "Orchestrator Service",
      "passes": true,
      "phase": "2-deterministic",
      "steps": [
        "Create src/lib/intelligence/orchestrator.ts",
        "Implement routeToLayer() - decides deterministic/probabilistic/exception",
        "Implement predictQuality() - main entry point",
        "Add probabilistic stub for future ML integration",
        "Wire existing prediction logic through orchestrator",
        "Write integration tests"
      ],
      "acceptance": "All predictions routed through orchestrator, tests pass",
      "files": ["src/lib/intelligence/orchestrator.ts", "src/__tests__/orchestrator.test.ts"],
      "completion_notes": "Created orchestrator service with: (1) routeToLayer() routing to deterministic/probabilistic/exception based on input; (2) predictQuality() main entry coordinating rules engine, claim inference, and validation; (3) Convenience functions: predictBrix(), assessBeefQuality(), assessFromPLU(); (4) Confidence calculation with factor breakdown; (5) Quality tier classification (artisan/premium/standard/commodity); (6) Exception handling with review flags; (7) Anomaly detection integration; (8) ML enhancement stub ready for F024. 50 tests. Total test suite: 585 tests."
    },
    {
      "id": "F017",
      "name": "Predictions Table Migration",
      "passes": true,
      "phase": "3-feedback",
      "steps": [
        "Create supabase/migrations/003_predictions.sql",
        "Define predictions table schema (cultivar, region, predicted_brix, confidence, etc.)",
        "Run migration",
        "Update prediction engine to store predictions",
        "Write tests"
      ],
      "acceptance": "Predictions saved to DB, queryable, tests pass",
      "files": ["supabase/migrations/003_predictions.sql"],
      "completion_notes": "Created predictions table via Supabase MCP with: cultivar_id, region_id, farm_crop_id, plu_code, prediction_date, current_gdd, peak_gdd, predicted_brix, brix_components (JSONB), quality_tier, confidence, confidence_factors (JSONB), prediction_layer, validation state, beef profile fields, ML tracking, source, request_id. Indexed on cultivar, region, date, needs_review, source, quality_tier. RLS enabled."
    },
    {
      "id": "F018",
      "name": "Actuals Table Migration",
      "passes": true,
      "phase": "3-feedback",
      "steps": [
        "Create supabase/migrations/004_actuals.sql",
        "Define actuals table (source_type, actual_brix, actual_harvest_date)",
        "Create API endpoint POST /api/actuals",
        "Run migration",
        "Write tests"
      ],
      "acceptance": "Actuals can be submitted via API, tests pass",
      "files": ["supabase/migrations/004_actuals.sql", "src/app/api/actuals/route.ts"],
      "completion_notes": "Created actuals table via Supabase MCP with: prediction_id FK, cultivar_id, region_id, actual_brix/ta/omega_ratio/moisture/ph measurements, source_type (consumer/farm/lab), lab verification fields, store location, data quality score, anomaly detection, photo evidence URLs. Added trigger to auto-calculate ratio and brimA. Indexed on cultivar, region, prediction, date, source, verified, brix."
    },
    {
      "id": "F019",
      "name": "Calibrations Table Migration",
      "passes": true,
      "phase": "3-feedback",
      "steps": [
        "Create supabase/migrations/005_calibrations.sql",
        "Define regional_calibrations table",
        "Run migration",
        "Write tests"
      ],
      "acceptance": "Calibrations table exists, queryable, tests pass",
      "files": ["supabase/migrations/005_calibrations.sql"],
      "completion_notes": "Created regional_calibrations table via Supabase MCP with: cultivar_id, region_id, season_year (unique constraint), running statistics (sample_count, brix_offset_mean/stddev/min/max), MAE metrics, confidence_boost. Added trigger on actuals insert to auto-update calibration using Welford's online algorithm for running mean. Confidence boost scales with sample count up to 0.1 at 50+ samples."
    },
    {
      "id": "F020",
      "name": "Calibration Engine",
      "passes": true,
      "phase": "3-feedback",
      "steps": [
        "Create src/lib/intelligence/calibration-engine.ts",
        "Implement updateCalibration() - running mean/stddev from actuals",
        "Implement applyCalibration() - adjust predictions with offsets",
        "Implement confidence_boost calculation based on sample size",
        "Write tests"
      ],
      "acceptance": "Calibrations applied to predictions, tests pass",
      "files": ["src/lib/intelligence/calibration-engine.ts", "src/__tests__/calibration-engine.test.ts"],
      "completion_notes": "Created calibration engine with: (1) getCalibration/getCalibrationWithFallback for retrieval; (2) applyCalibration/applyCalibrationSync using Brix offset mean; (3) calculateRunningStats using Welford's algorithm; (4) calculateConfidenceBoost scaling linearly to MAX_CONFIDENCE_BOOST; (5) submitActual for consumer/farm/lab submissions; (6) getCalibrationStats for reporting. 32 tests. Total test suite: 617 tests."
    },
    {
      "id": "F021",
      "name": "Consumer Scan API",
      "passes": true,
      "phase": "3-feedback",
      "steps": [
        "Create POST /api/scans endpoint",
        "Validate scan data (PLU, brix, location)",
        "Store in actuals table",
        "Trigger calibration update",
        "Write tests"
      ],
      "acceptance": "Scans stored, calibration updated, tests pass",
      "files": ["src/app/api/scans/route.ts", "src/__tests__/scans-api.test.ts"],
      "completion_notes": "Created Consumer Scan API with: (1) POST endpoint for consumer refractometer readings; (2) Request validation (actualBrix required, PLU format 4-5 digits, coordinates, date); (3) Physical Brix validation via validation engine; (4) PLU inference integration; (5) Data quality assessment; (6) Storage in actuals table; (7) GET endpoint for API documentation. 67 tests covering validation, scenarios, response structure, integrations. Total test suite: 684 tests."
    },
    {
      "id": "F022",
      "name": "Exception Handler",
      "passes": true,
      "phase": "4-ai",
      "steps": [
        "Create supabase/migrations/006_exceptions.sql",
        "Create src/lib/intelligence/exception-handler.ts",
        "Implement shouldEscalate() - confidence thresholds",
        "Implement addToReviewQueue()",
        "Write tests"
      ],
      "acceptance": "Low-confidence predictions queued, tests pass",
      "files": ["src/lib/intelligence/exception-handler.ts", "src/__tests__/exception-handler.test.ts"],
      "completion_notes": "Created exceptions table via Supabase MCP with: status tracking, severity levels, SLA deadlines, auto-resolve capability. Created exception handler with: (1) shouldEscalate() using confidence/anomaly/validation thresholds; (2) getSeverityFromConfidence/Anomaly; (3) addToReviewQueue(); (4) getPendingExceptions(); (5) updateExceptionStatus/assignException; (6) autoResolveExpired(); (7) getQueueStats(); (8) SLA time tracking with isOverdue/getTimeUntilSla. 61 tests. Total test suite: 745 tests."
    },
    {
      "id": "F023",
      "name": "Accuracy Reporting",
      "passes": true,
      "phase": "4-ai",
      "steps": [
        "Create supabase/migrations/007_accuracy_reports.sql",
        "Create src/lib/analytics/accuracy-reporter.ts",
        "Implement generateReport() - MAE, % within thresholds",
        "Create /api/admin/accuracy endpoint",
        "Write tests"
      ],
      "acceptance": "Accuracy reports generated, tests pass",
      "files": ["src/lib/analytics/accuracy-reporter.ts", "src/app/api/admin/accuracy/route.ts", "src/__tests__/accuracy-reporter.test.ts"],
      "completion_notes": "Created accuracy_reports table via Supabase MCP with: error metrics (MAE/MSE/RMSE/MAPE), bias metrics, distribution metrics (pct_within_05/10/15/20), confidence correlation, tier accuracy JSONB, trend indicators, alert flags. Created accuracy reporter with: (1) calculateMetrics() for all error/bias/distribution metrics; (2) calculateTierAccuracy() by quality tier; (3) determineTrend() for improvement/degradation detection; (4) checkAlerts() with configurable thresholds; (5) generateReport() with scope filters; (6) Admin API GET/POST endpoints. 43 tests. Total test suite: 788 tests."
    },
    {
      "id": "F024",
      "name": "Brix ML Service (MVP)",
      "passes": true,
      "phase": "4-ai",
      "steps": [
        "Create src/lib/intelligence/brix-ml-service.ts",
        "Implement feature extraction (weather, soil, practices)",
        "Implement simple ML model or call external API",
        "A/B testing: formula vs ML-enhanced",
        "Write tests"
      ],
      "acceptance": "ML predictions available, A/B framework works",
      "files": ["src/lib/intelligence/brix-ml-service.ts", "src/__tests__/brix-ml-service.test.ts"],
      "completion_notes": "Created Brix ML Service MVP with: (1) extractFeatures() for SHARE pillar features (cultivar, environment, timing, tree, calibration, practices); (2) featuresToArray() for model input; (3) Feature encodings for fertility/pest management; (4) A/B testing with assignABGroup() using consistent hash, shouldUseML(), DEFAULT_EXPERIMENT; (5) getMLPrediction() with formula fallback and ML heuristic; (6) Model management stubs (getActiveModel, logPrediction, getExperimentResults). 41 tests. Total test suite: 829 tests."
    },
    {
      "id": "F025",
      "name": "Init Script + CI/CD",
      "passes": true,
      "phase": "4-ai",
      "steps": [
        "Create init.sh for environment validation",
        "Create .github/workflows/test.yml",
        "Verify test suite runs in CI",
        "Add build validation on PR",
        "Document in README"
      ],
      "acceptance": "CI passes, init.sh validates environment",
      "files": ["init.sh", ".github/workflows/test.yml"],
      "completion_notes": "Created/updated init.sh with Node.js version check, dependency verification, TypeScript compilation check (using tsc --noEmit), full test suite run with count reporting, and feature status display. Created .github/workflows/test.yml with matrix build (Node 18.x/20.x), lint, type check, test with coverage, and production build steps. Updated README with comprehensive documentation including CI/CD setup, project structure, and development workflow. 829 tests passing."
    },
    {
      "id": "F026",
      "name": "Admin Exception UI",
      "passes": true,
      "phase": "4-ai",
      "depends_on": ["F022"],
      "steps": [
        "Create /admin/exceptions page",
        "List pending exceptions with context",
        "Allow approve/reject/escalate actions",
        "Track resolution time metrics"
      ],
      "acceptance": "Exceptions can be resolved via UI",
      "files": ["src/app/admin/exceptions/page.tsx", "src/app/api/admin/exceptions/route.ts"],
      "completion_notes": "Created admin exception UI with: (1) Dashboard showing pending/in-review/overdue/resolved-today stats; (2) Filter by status, severity, exception type; (3) Exception list with severity badges, SLA tracking, overdue warnings; (4) Inline review panel with resolution notes; (5) Approve/reject/escalate actions. Created API routes: GET /api/admin/exceptions (list with filters), GET /api/admin/exceptions/stats (queue stats), POST /api/admin/exceptions/actions (resolve). Added getExceptionStats() and resolveException() to exception-handler.ts. 829 tests passing."
    },
    {
      "id": "F027",
      "name": "Model Versioning",
      "passes": true,
      "phase": "4-ai",
      "depends_on": ["F024"],
      "steps": [
        "Create model_versions table",
        "Store model artifacts with version ID",
        "A/B routing by model version",
        "Rollback mechanism"
      ],
      "acceptance": "Multiple model versions coexist, can rollback",
      "files": ["supabase/migrations/008_model_versions.sql", "src/lib/intelligence/brix-ml-service.ts"],
      "completion_notes": "Created model_versions table via Supabase MCP with: version ID, model type, is_active/is_production/is_rollback_target flags, training metadata (trained_at, sample_count), performance metrics (mae, rmse, mape, r_squared), features JSONB, model_artifact_url, experiment_id, traffic_percentage. Added ModelVersionRecord type and functions: getAllModelVersions(), getProductionModel(), setProductionModel(), rollbackModel(), registerModelVersion(), updateModelTraffic(). Unique index ensures one production model per type. Default formula_v1 seeded. 829 tests passing."
    },
    {
      "id": "F028",
      "name": "Observability Dashboard",
      "passes": true,
      "phase": "4-ai",
      "depends_on": ["F023"],
      "steps": [
        "Create /admin/monitoring page",
        "Real-time accuracy metrics",
        "Alert thresholds for RMSE increase",
        "Historical accuracy trends"
      ],
      "acceptance": "Dashboard shows live accuracy, alerts work",
      "files": ["src/app/admin/monitoring/page.tsx"],
      "completion_notes": "Created admin monitoring dashboard with: (1) Real-time accuracy metrics (MAE, RMSE, MAPE); (2) Alert thresholds for MAE degradation (warning > 0.8, critical > 1.2); (3) Historical accuracy trends with trend direction; (4) System health display (predictions/24h, avg confidence, exception rate, latency); (5) Model version performance comparison. Created API routes: GET /api/admin/models, GET /api/admin/health. 829 tests passing."
    },
    {
      "id": "F029",
      "name": "API Rate Limiting",
      "passes": true,
      "phase": "3-feedback",
      "depends_on": ["F021"],
      "steps": [
        "Add rate limiting middleware",
        "Configure per-user and global limits",
        "Return 429 with retry-after header",
        "Log rate limit events"
      ],
      "acceptance": "Excessive requests throttled",
      "files": ["src/middleware.ts", "src/lib/rate-limit.ts"],
      "completion_notes": "Created rate limiting system with: (1) Sliding window algorithm in src/lib/rate-limit.ts; (2) Per-endpoint configs (consumer=30/min, prediction=60/min, admin=120/min, global=100/min); (3) Next.js middleware at src/middleware.ts applying limits to all API routes; (4) Identifier extraction (userId > deviceId > IP); (5) 429 response with Retry-After header and X-RateLimit-* headers; (6) Event logging and stats via GET /api/admin/rate-limits. 32 new tests. Total: 861 tests passing."
    },
    {
      "id": "F030",
      "name": "Historical Backfill",
      "passes": true,
      "phase": "4-ai",
      "depends_on": ["F017", "F018", "F019"],
      "steps": [
        "Create backfill script",
        "Generate predictions for past seasons",
        "Import any available historical measurements",
        "Seed calibrations with baseline offsets"
      ],
      "acceptance": "Historical data available for ML training",
      "files": ["scripts/backfill-historical.ts"],
      "completion_notes": "Created scripts/backfill-historical.ts with: (1) Cultivar-region mappings for 12 cultivars across 21 regions; (2) Harvest season definitions per crop type; (3) Gaussian-distributed synthetic actuals from predictions; (4) Calibration calculation with Welford's running mean/stddev; (5) Command-line options: --dry-run, --seasons=N, --samples=N; (6) Batch inserts for predictions and actuals; (7) Upsert for calibrations with unique constraint. Added ts-node dependency and npm scripts: backfill, backfill:dry-run. Created unique index on regional_calibrations. 861 tests passing."
    },
    {
      "id": "F031",
      "name": "Data Model Clarification",
      "passes": true,
      "phase": "5-refinement",
      "steps": [
        "Audit naming: Product vs ProductType vs ProductVariant across codebase",
        "Decide canonical naming: ProductType = taxonomy, Listing = SKU, ListingVariant = size/packaging variant",
        "Remove confusing Product = ProductType alias from products.ts",
        "Rename Product to Listing in product-model.ts",
        "Define new ListingVariant interface for size/packaging variants",
        "Update enrich-measurements.ts target types: product → listing, product_variant → listing_variant",
        "Update all references (predictions page ProductType import)",
        "Document the hierarchy clearly"
      ],
      "acceptance": "Clear, unambiguous naming throughout codebase with documentation",
      "files": ["src/lib/constants/products.ts", "src/lib/constants/product-model.ts", "src/lib/constants/enrich-measurements.ts"],
      "completion_notes": "Clarified data model naming: (1) ProductType = taxonomy level (Orange, Beef) - stays in products.ts; (2) Listing = purchasable SKU (Farm + Cultivar + SHARE + Retail) - renamed from Product in product-model.ts; (3) ListingVariant = same listing, different size/packaging (new interface). Removed confusing Product = ProductType alias. Updated enrich-measurements.ts target types. Fixed predictions page import. Hierarchy: Category → ProductType → Variety → Cultivar → Listing → ListingVariant. 1118 tests passing."
    },
    {
      "id": "F032",
      "name": "Discovery Endpoint - What's At Peak Today",
      "passes": false,
      "phase": "5-refinement",
      "depends_on": ["F031"],
      "steps": [
        "Create GET /api/discover/peak endpoint",
        "Iterate all Cultivar × Region combinations",
        "Run predictions for current date/GDD",
        "Filter to harvestStatus === 'peak' or 'optimal'",
        "Group results by category",
        "Return aggregated 'what's at peak today' list",
        "Add caching (results valid for ~1 day)"
      ],
      "acceptance": "Endpoint returns all products currently at peak quality across all regions",
      "files": ["src/app/api/discover/peak/route.ts"],
      "notes": "This is the ORIGINAL vision for the predictor - a discovery engine showing what's best RIGHT NOW. Not just single predictions, but a daily view of peak quality items across all categories, regions, and cultivars."
    }
  ]
}
